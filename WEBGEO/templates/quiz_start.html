{% block content %}
  <h1>{{ quiz.title }}</h1>
  <h2>Question {{ current_question_number }} of {{ total_questions }}</h2>
  <div>
    <p>{{ question.text }}</p>
    <form method="post" action="{% url 'quiz_submit_answer' quiz_attempt_id=quiz_attempt_id %}">
      {% csrf_token %}
      <input type="hidden" name="question_id" value="{{ question.id }}">
      {% if question.question_type == 'ChooseOne' %}
        <ul>
          {% for answer in question.answer_set.all %}
            <li>
              <label>
                <input type="radio" name="answer_id" value="{{ answer.id }}">
                {{ answer.text }}
              </label>
            </li>
          {% endfor %}
        </ul>
      {% elif question.question_type == 'EnterText' %}
        <div class="form-group">
          <input type="text" class="form-control" name="answer_text" id="answer_text">
        </div>
      {% endif %}

      <input type="submit" value="Submit">
    </form>

    {% if has_prev_question %}
      <a href="{% url 'quiz_question' quiz_attempt_id=quiz_attempt_id current_question_number=prev_question_number %}" class="btn btn-secondary">Prev</a>
    {% endif %}
    {% if has_next_question %}
      <a href="{% url 'quiz_question' quiz_attempt_id=quiz_attempt_id current_question_number=next_question_number %}" class="btn btn-secondary">Next</a>
    {% else %}
      <a href="{% url 'quiz_result' quiz_id=quiz.id quiz_attempt_id=quiz_attempt_id %}" class="btn btn-primary">Submit</a>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    var quiz_id = {{ quiz.id }};
    var questions = {{ questions|safe }};
    var current_question = {{ current_question }};
    var total_score = 0;

    function submitAnswer(answer_id, quiz_attempt_id) {
      var data = {'quiz_attempt_id': quiz_attempt_id, 'question_id': questions[current_question].id, 'answer_id': answer_id};
      $.post('{% url "quiz_submit_answer" quiz_attempt_id=quiz_attempt_id %}', data, function(response) {
        console.log(response);
        if (response.is_correct) {
          total_score += response.score;
        }
        current_question++;
        if (current_question == questions.length) {
          window.location.href = "{% url 'quiz_result' quiz_id=quiz.id quiz_attempt_id=quiz_attempt_id %}";
        } else {
          $('#question-container').load("{% url 'quiz_question' quiz_attempt_id=quiz_attempt_id current_question_number=current_question %}");
        }
      });
    }

    $(document).ready(function() {
      $('.answer-button').click(function() {
        var answer_id = $(this).data('answer-id');
        var quiz_attempt_id = $(this).data('quiz-attempt-id');
        submitAnswer(answer_id, quiz_attempt_id);
      });
    });
  </script>
{% endblock %}