{% block title %}{{ quiz.title }}{% endblock %}

{% block content %}
  <h1>{{ quiz.title }}</h1>
  <form method="post" id="quiz-form">
    {% csrf_token %}
    {% for question in questions %}
      <h3>{{ question.question_text }}</h3>
      {% if question.question_type == 'c' %}
        <div id="map-container" style="height: 400px;"></div>
        <button id="accept-answer-btn" type="button">Ответить</button>
      {% elif question.question_type == 't' %}
        <input type="text" id="text-answer-input" name="{{ question.question_id }}">
        <button type="submit">Ответить</button>
      {% endif %}
      <script>
        {% if question.question_type == 'c' %}
         // Инициализация карты
         var mymap = L.map('map-container').setView([55.76, 37.64], 5);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
         }).addTo(mymap);

         // Отображение маркера на карте
         var marker = L.marker([{{ question.options.0.latitude }}, {{ question.options.0.longitude }}], {
          draggable: true
         }).addTo(mymap);

         // Обработка событий кнопки "Ответить"
         document.querySelector('#accept-answer-btn').addEventListener('click', function() {
          fetch('{% url 'check_answer' %}', {
           method: 'POST',
           credentials: 'include',
           headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify({
            'answer': marker.getLatLng()
           })
          }).then(response => response.json()).then(data => {
           if (data.result === 'correct') {
            alert('Ответ верный! Вы получили ' + data.score + ' баллов.');
           } else if (data.result === 'wrong') {
            alert('Ответ неверный!');
           }
          });
         });

         // Функция вычисления расстояния между двумя точками на карте
         function calcDistance(lat1, lon1, lat2, lon2) {
          var R = 6371; // Радиус Земли (км)
          var dLat = (lat2 - lat1) * Math.PI / 180;
          var dLon = (lon2 - lon1) * Math.PI / 180;
          var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
           Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
           Math.sin(dLon / 2) * Math.sin(dLon / 2);
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          var d = R * c;
          return d;
         }
        {% endif %}

        // Функция получения CSRF-токена из cookie
        function getCookie(name) {
         var cookieValue = null;
         if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
           var cookie = cookies[i].trim();
           // Извлечение CSRF-токена из cookie
           if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
           }
          }
         }
         return cookieValue;
        }
      </script>
    {% endfor %}
  </form>
{% endblock %}